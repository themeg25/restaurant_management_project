# settings.py

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'your_email@gmail.com'
EMAIL_HOST_PASSWORD = 'your_app_password'  # Use an App Password
DEFAULT_FROM_EMAIL = 'yourimport logging
from django.core.mail import send_mail, BadHeaderError
from django.conf import settings
from smtplib import SMTPException

logger = logging.getLogger(__name__)

def send_order_confirmation_email(order_id, customer_email, customer_name, order_items, total_price):
    """
        Sends an order confirmation email to the user.
        
            Args:
                    order_id (str): Unique order identifier.
                            customer_email (str): User's email address.
                                    customer_name (str): User's name.
                                            order_items (list of dict): List of items with 'name', 'quantity', and 'price'.
                                                    total_price (Decimal or str): Total price of the order.
                                                    
                                                        Returns:
                                                                bool: True if email sent successfully, False otherwise.
                                                                    """
                                                                    
                                                                        subject = f"Order Confirmation - {order_id}"
                                                                            from_email = settings.DEFAULT_FROM_EMAIL
                                                                                recipient_list = [customer_email]
                                                                                
                                                                                    # Create a readable list of items
                                                                                        items_list = "\n".join(
                                                                                                    [f"- {item['name']} (x{item['quantity']}): ${item['price']}" for item in order_items]
                                                                                                        )
                                                                                                        
                                                                                                            message = (
                                                                                                                        f"Hello {customer_name},\n\n"
                                                                                                                                f"Thank you for your order!\n"
                                                                                                                                        f"Your order ID is: {order_id}\n\n"
                                                                                                                                                f"Order Details:\n{items_list}\n\n"
                                                                                                                                                        f"Total Price: ${total_price}\n\n"
                                                                                                                                                                f"We will notify you when your order is on its way.\n\n"
                                                                                                                                                                        f"Best regards,\n"
                                                                                                                                                                                f"The Support Team"
                                                                                                                                                                                    )
                                                                                                                                                                                    
                                                                                                                                                                                        try:
                                                                                                                                                                                                send_mail(subject, message, from_email, recipient_list, fail_silently=False)
                                                                                                                                                                                                        logger.info(f"Order confirmation email sent to {customer_email} for Order {order_id}")
                                                                                                                                                                                                                return True
                                                                                                                                                                                                                    except BadHeaderError:
                                                                                                                                                                                                                            logger.error(f"Invalid header detected when sending email to {customer_email}.")
                                                                                                                                                                                                                                except SMTPException as e:
                                                                                                                                                                                                                                        logger.error(f"SMTP error occurred while sending email to {customer_email}: {e}")
                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                    logger.error(f"Unexpected error while sending email to {customer_email}: {e}")
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                        return False_email@gmail.com'# Example in orders/views.py
                                                                                                                                                                                                                                                        from rest_framework.response import Response
                                                                                                                                                                                                                                                        from rest_framework.views import APIView
                                                                                                                                                                                                                                                        from .utils import send_order_confirmation_email
                                                                                                                                                                                                                                                        from .models import Order

                                                                                                                                                                                                                                                        class PlaceOrderView(APIView):
                                                                                                                                                                                                                                                            def post(self, request):
                                                                                                                                                                                                                                                                    # Assume order is created successfully
                                                                                                                                                                                                                                                                            order = Order.objects.create(
                                                                                                                                                                                                                                                                                            user=request.user,
                                                                                                                                                                                                                                                                                                        order_id="ORD12345",
                                                                                                                                                                                                                                                                                                                    total_price=59.99
                                                                                                                                                                                                                                                                                                                            )

                                                                                                                                                                                                                                                                                                                                    # Example order items
                                                                                                                                                                                                                                                                                                                                            order_items = [
                                                                                                                                                                                                                                                                                                                                                            {"name": "Pizza", "quantity": 2, "price": "15.00"},
                                                                                                                                                                                                                                                                                                                                                                        {"name": "Coke", "quantity": 1, "price": "2.00"},
                                                                                                                                                                                                                                                                                                                                                                                ]

                                                                                                                                                                                                                                                                                                                                                                                        # Send confirmation email
                                                                                                                                                                                                                                                                                                                                                                                                email_sent = send_order_confirmation_email(
                                                                                                                                                                                                                                                                                                                                                                                                                order_id=order.order_id,
                                                                                                                                                                                                                                                                                                                                                                                                                            customer_email=request.user.email,
                                                                                                                                                                                                                                                                                                                                                                                                                                        customer_name=request.user.get_full_name() or request.user.username,
                                                                                                                                                                                                                                                                                                                                                                                                                                                    order_items=order_items,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                total_price=order.total_price
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not email_sent:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return Response({"message": "Order placed but email failed to send."}, status=201)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return Response({"message": "Order placed and confirmation email sent!"}, status=201)
                                                                                                                                                                                                                                                                                                                                                                                                )
                                                                                                                                                                                                                                                                                                                                            ]
                                                                                                                                                                                                                                                                            )